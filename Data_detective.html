<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Data Detective â€” Anomaly Clue Game</title>
<style>
  :root{--bg:#f7f9fb;--card:#fff;--accent:#2952ff;--danger:#ff6347;--muted:#6b7280}
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:18px;color:#0f172a}
  .wrap{max-width:980px;margin:0 auto}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{font-size:20px;margin:0}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(12,16,32,0.06);margin-bottom:12px}
  input[type=file]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef8;background:#fafcff}
  button{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid #e6eef8;color:var(--accent)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .flex{display:flex;gap:8px;align-items:center}
  #previewTable{width:100%;border-collapse:collapse;margin-top:10px;display:block;overflow:auto}
  table th,table td{border:1px solid #eef2f7;padding:8px;white-space:nowrap}
  table th{background:#f3f7ff;position:sticky;top:0}
  .anomaly-row{background:linear-gradient(90deg, rgba(255,99,71,0.06), rgba(255,99,71,0.02))}
  .tag{display:inline-block;padding:6px 8px;border-radius:10px;background:#f1f5f9;color:#0f172a;font-size:13px}
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-top:10px}
  .small{font-size:13px;color:var(--muted)}
  .clue-card{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid #eef2f7;margin-bottom:8px}
  .clue-info{max-width:70%}
  .score{font-weight:700;color:var(--accent)}
  .footer{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
  @media (max-width:520px){ header{flex-direction:column;align-items:flex-start} .controls{flex-direction:column} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>ðŸ”Ž Data Detective â€” Find the Clues</h1>
      <div class="small">Upload a CSV / Excel file. The tool finds anomalous rows as "clues". Click to investigate & score.</div>
    </div>
    <div class="flex">
      <div class="small">Score: <span id="score" class="score">0</span></div>
      <button id="resetBtn" class="btn-ghost">Reset Game</button>
    </div>
  </header>

  <section class="card">
    <label class="small">Upload CSV / Excel (.csv, .xlsx, .xls)</label>
    <input id="fileInput" type="file" accept=".csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" />
    <div class="controls">
      <button id="analyzeBtn">Analyze File</button>
      <button id="exportBtn" class="btn-ghost">Export Anomalies (CSV)</button>
      <select id="methodSelect" class="small">
        <option value="both">Detect: IQR + Z-score</option>
        <option value="iqr">IQR (boxplot) only</option>
        <option value="zscore">Z-score only</option>
      </select>
      <label class="small" style="align-self:center">Z cutoff:
        <input id="zcut" type="number" value="3" step="0.5" style="width:72px;margin-left:6px;padding:6px;border-radius:6px;border:1px solid #e6eef8" />
      </label>
    </div>

    <div id="summary" style="margin-top:12px" class="small"></div>
  </section>

  <section class="card" id="previewCard">
    <h3 style="margin:0 0 8px 0">Preview (first rows)</h3>
    <div id="preview"></div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px 0">Detected Clues (Anomalies)</h3>
    <div id="cluesList"></div>
    <div id="noClueMsg" class="small" style="display:none">No anomalies found. Try changing method or increase sensitivity.</div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px 0">Investigation Output</h3>
    <div id="investigation" class="small">Click a clue to reveal details and possible causes.</div>
  </section>

  <div class="footer">
    <div class="small">Tip: For Google Sheets export to CSV first (File â†’ Download â†’ CSV) then upload.</div>
    <div class="small">Built for mobile & desktop â€” offline</div>
  </div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
(function(){
  // Game state
  let rows = [];          // full dataset (array of objects)
  let columns = [];       // column names
  let anomalies = [];     // list of anomaly objects {index, column, value, reason}
  let score = 0;
  const maxPreview = 30;

  // DOM
  const fileInput = document.getElementById('fileInput');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const previewDiv = document.getElementById('preview');
  const summaryDiv = document.getElementById('summary');
  const cluesList = document.getElementById('cluesList');
  const investigation = document.getElementById('investigation');
  const scoreEl = document.getElementById('score');
  const exportBtn = document.getElementById('exportBtn');
  const resetBtn = document.getElementById('resetBtn');
  const methodSelect = document.getElementById('methodSelect');
  const zcutInput = document.getElementById('zcut');
  const noClueMsg = document.getElementById('noClueMsg');

  function resetGame(){
    rows = []; columns=[]; anomalies=[]; score = 0;
    previewDiv.innerHTML = ''; cluesList.innerHTML=''; investigation.innerHTML=''; summaryDiv.innerHTML='';
    scoreEl.textContent = score; noClueMsg.style.display='none';
    fileInput.value = '';
  }

  resetBtn.addEventListener('click', resetGame);

  // Read file (CSV or Excel)
  function readFile(file){
    const ext = file.name.split('.').pop().toLowerCase();
    if(ext === 'csv'){
      Papa.parse(file, {header:true, dynamicTyping:true, skipEmptyLines:true,
        complete: function(res){ rows = res.data; onFileLoaded(); }});
    } else {
      const reader = new FileReader();
      reader.onload = function(e){
        const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        rows = XLSX.utils.sheet_to_json(sheet, {defval:null});
        onFileLoaded();
      };
      reader.readAsArrayBuffer(file);
    }
  }

  fileInput.addEventListener('change', e => {
    if(e.target.files && e.target.files[0]) readFile(e.target.files[0]);
  });

  function onFileLoaded(){
    if(!rows || rows.length===0){ previewDiv.innerHTML = '<div class="small">No rows found in file.</div>'; return; }
    columns = Object.keys(rows[0]);
    renderPreview();
    summaryDiv.innerHTML = `<div class="small">Rows: ${rows.length} â€¢ Columns: ${columns.length} â€¢ Numeric cols auto-detected.</div>`;
  }

  function renderPreview(){
    let html = '<table id="previewTable"><thead><tr>';
    columns.forEach(c=> html += `<th>${escapeHtml(c)}</th>`);
    html += '</tr></thead><tbody>';
    rows.slice(0, maxPreview).forEach((r, i)=> {
      html += '<tr>';
      columns.forEach(c=> html += `<td>${escapeHtml(String(r[c]===null||r[c]===undefined ? '' : r[c]))}</td>`);
      html += '</tr>';
    });
    html += '</tbody></table>';
    previewDiv.innerHTML = html;
  }

  function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // Run analysis and find anomalies
  analyzeBtn.addEventListener('click', function(){
    if(!rows || rows.length===0){ alert('Please upload a file first'); return; }
    anomalies = [];
    const method = methodSelect.value;
    const zcut = parseFloat(zcutInput.value) || 3;

    const numericCols = detectNumericColumns(rows, columns);
    const catCols = columns.filter(c => !numericCols.includes(c));

    if(method === 'iqr' || method === 'both'){
      numericCols.forEach(col => detectIQRAnomalies(rows, col));
    }
    if(method === 'zscore' || method === 'both'){
      numericCols.forEach(col => detectZscoreAnomalies(rows, col, zcut));
    }

    // detect rare categorical values as anomalies (frequency less than threshold)
    detectRareCategorical(rows, catCols);

    // dedupe anomalies by row+col
    anomalies = dedupeAnomalies(anomalies);
    renderClues();
    score = 0;
    scoreEl.textContent = score;
    if(anomalies.length === 0){ noClueMsg.style.display='block'; } else { noClueMsg.style.display='none'; }
  });

  // Detect numeric columns by sampling values
  function detectNumericColumns(data, cols){
    const numeric = [];
    cols.forEach(c=>{
      let countNum = 0, countAll=0;
      for(let i=0;i<data.length;i++){
        const v = data[i][c];
        if(v !== null && v !== undefined && v !== '') countAll++;
        if(typeof v === 'number' && !isNaN(v)) countNum++;
        // also allow numbers in strings like "123"
        else if(typeof v === 'string' && v.trim() !== '' && !isNaN(Number(v.trim()))) countNum++;
      }
      if(countAll>0 && (countNum / countAll) > 0.6) numeric.push(c);
    });
    return numeric;
  }

  // IQR anomaly detection: flag values outside [Q1 - 1.5IQR, Q3 + 1.5IQR]
  function detectIQRAnomalies(data, col){
    const vals = data.map(r=>convertNum(r[col])).filter(v=>v!==null);
    if(vals.length < 6) return;
    vals.sort((a,b)=>a-b);
    const q1 = quantile(vals,0.25), q3 = quantile(vals,0.75), iqr = q3 - q1;
    const lo = q1 - 1.5 * iqr, hi = q3 + 1.5 * iqr;
    data.forEach((r,i)=>{
      const v = convertNum(r[col]);
      if(v===null) return;
      if(v < lo || v > hi){
        anomalies.push({index:i, column:col, value:v, reason:`IQR (outside ${lo.toFixed(2)}â€“${hi.toFixed(2)})`});
      }
    });
  }

  // Z-score detection: flag |z| > cutoff
  function detectZscoreAnomalies(data, col, cutoff){
    const vals = data.map(r=>convertNum(r[col])).filter(v=>v!==null);
    if(vals.length < 6) return;
    const mean = meanOf(vals), sd = sdOf(vals, mean);
    if(sd === 0) return;
    data.forEach((r,i)=>{
      const v = convertNum(r[col]);
      if(v===null) return;
      const z = Math.abs((v - mean) / sd);
      if(z > cutoff){
        anomalies.push({index:i, column:col, value:v, reason:`Z-score (${z.toFixed(2)} > ${cutoff})`});
      }
    });
  }

  // Rare categorical detection (frequency < 1% or less than 3 occurrences)
  function detectRareCategorical(data, cols){
    cols.forEach(col=>{
      const freq = {};
      data.forEach(r=>{
        const k = String(r[col]===null||r[col]===undefined ? '' : r[col]);
        freq[k] = (freq[k]||0) + 1;
      });
      const threshold = Math.max(3, Math.ceil(data.length * 0.01));
      Object.keys(freq).forEach(k=>{
        if(freq[k] <= threshold){
          // find rows with this rare value
          data.forEach((r,i)=>{ if(String(r[col]===null||r[col]===undefined ? '' : r[col]) === k) {
            anomalies.push({index:i, column:col, value:r[col], reason:`Rare categorical (freq=${freq[k]})`});
          }});
        }
      });
    });
  }

  // Helper numeric conversion
  function convertNum(v){
    if(v === null || v === undefined || v === '') return null;
    if(typeof v === 'number' && !isNaN(v)) return v;
    if(typeof v === 'string'){
      const n = Number(v.replace(/,/g,'')); // remove commas
      return isNaN(n)? null : n;
    }
    return null;
  }

  // math helpers
  function quantile(sortedArr, q){
    const pos = (sortedArr.length - 1) * q;
    const base = Math.floor(pos), rest = pos - base;
    if(sortedArr[base+1] !== undefined) return sortedArr[base] + rest * (sortedArr[base+1] - sortedArr[base]);
    return sortedArr[base];
  }
  function meanOf(a){return a.reduce((s,x)=>s+x,0)/a.length}
  function sdOf(a, mean){return Math.sqrt(a.reduce((s,x)=>s+(x-mean)*(x-mean),0)/a.length)}

  function dedupeAnomalies(list){
    const seen = new Set();
    const out = [];
    list.forEach(a=>{
      const key = `${a.index}||${a.column}`;
      if(!seen.has(key)){ seen.add(key); out.push(a); }
    });
    // sort by index
    out.sort((x,y)=>x.index - y.index);
    return out;
  }

  // Render clues list
  function renderClues(){
    cluesList.innerHTML = '';
    if(!anomalies || anomalies.length===0) { cluesList.innerHTML = '<div class="small">No clues found.</div>'; return; }
    anomalies.forEach((a, i) => {
      const div = document.createElement('div');
      div.className = 'clue-card';
      div.innerHTML = `<div class="clue-info"><div><strong>Row ${a.index+1}</strong> â€¢ <span class="small">${escapeHtml(a.column)}</span></div>
                       <div class="small">Value: <span class="tag">${escapeHtml(String(a.value))}</span> â€¢ ${escapeHtml(a.reason)}</div></div>
                       <div><button data-i="${i}">Investigate</button></div>`;
      cluesList.appendChild(div);
    });

    // attach click handlers
    cluesList.querySelectorAll('button').forEach(btn => btn.addEventListener('click', function(){
      const i = parseInt(this.getAttribute('data-i'),10);
      investigateClue(anomalies[i]);
    }));
  }

  // Investigate: reveal full row, possible explanations, give points for new finds
  function investigateClue(a){
    const row = rows[a.index];
    let details = `<div><strong>Row ${a.index+1} â€” Column: ${escapeHtml(a.column)}</strong></div>`;
    details += `<div class="small">Anomaly reason: ${escapeHtml(a.reason)}</div>`;
    details += '<hr />';
    details += '<div><strong>Full record:</strong></div><table style="width:100%;border-collapse:collapse"><tbody>';
    Object.keys(row).forEach(k=> {
      details += `<tr><td style="border:1px solid #eef2f7;padding:6px"><strong>${escapeHtml(k)}</strong></td><td style="border:1px solid #eef2f7;padding:6px">${escapeHtml(String(row[k]===null||row[k]===undefined?'':row[k]))}</td></tr>`;
    });
    details += '</tbody></table>';

    // generate "clue hint" - simple heuristics
    const tip = generateClueHint(a, row);
    details += `<div style="margin-top:8px;padding:8px;border-radius:8px;background:#f8fafc"><strong>Investigation hint:</strong><div class="small" style="margin-top:6px">${escapeHtml(tip)}</div></div>`;

    // Mark investigated: award points for first-time investigation of that anomaly
    if(!a._investigated){
      a._investigated = true;
      // awarding points: rarer events give more points
      let pts = 10;
      if(a.reason && a.reason.includes('Rare categorical')) pts = 15;
      if(a.reason && a.reason.includes('Z-score')) pts = 12;
      if(a.reason && a.reason.includes('IQR')) pts = 10;
      score += pts;
      scoreEl.textContent = score;
    }

    investigation.innerHTML = details;
    // highlight preview row visually if present
    highlightPreviewRow(a.index);
  }

  function generateClueHint(anom, row){
    // very simple natural-language style hints based on patterns
    const col = anom.column;
    const val = anom.value;
    if(anom.reason.includes('Rare categorical')) {
      return `This value in column "${col}" appears very infrequently (${String(val)}). It may be an outlier category or data entry error. Check similar rows or context fields for typos.`;
    }
    // numeric cases
    if(anom.reason.includes('Z-score') || anom.reason.includes('IQR')){
      const colVals = rows.map(r=>convertNum(r[col])).filter(v=>v!==null);
      const mean = colVals.length? meanOf(colVals).toFixed(2) : 'N/A';
      return `Numeric anomaly in "${col}" with value ${val}. Column mean â‰ˆ ${mean}. Possible causes: measurement error, different unit, duplicate, or genuine exceptional event. Look for other fields (e.g., date, id, category) for context.`;
    }
    return `Anomaly detected in "${col}" with value ${val}. Investigate neighboring fields and row history.`;
  }

  function highlightPreviewRow(index){
    // try to find the preview table row and highlight it (only if index within preview)
    const table = document.getElementById('previewTable');
    if(!table) return;
    const tbody = table.tBodies[0];
    const rowPos = index; // 0-based
    // only highlight if within displayed preview
    if(rowPos < maxPreview){
      // clear previous
      for(let r of tbody.rows) r.classList.remove('anomaly-row');
      const r = tbody.rows[rowPos];
      if(r) r.classList.add('anomaly-row');
      // scroll into view horizontally on mobile
      r && r.scrollIntoView({behavior:'smooth', block:'center'});
    }
  }

  // Export anomalies as CSV
  exportBtn.addEventListener('click', function(){
    if(!anomalies || anomalies.length===0){ alert('No anomalies to export'); return; }
    // Create CSV rows: include index, column, reason and full record
    const header = ['row_index','column','value','reason', ...columns];
    const lines = [header.join(',')];
    anomalies.forEach(a=>{
      const row = rows[a.index];
      const base = [a.index+1, `"${String(a.column).replace(/"/g,'""')}"`, `"${String(a.value).toString().replace(/"/g,'""')}"`, `"${String(a.reason).replace(/"/g,'""')}"`];
      const rest = columns.map(c => `"${String(row[c]===null||row[c]===undefined?'':row[c]).replace(/"/g,'""')}"`);
      lines.push(base.concat(rest).join(','));
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'anomalies_export.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // utilities
  function meanOf(a){ return a.reduce((s,x)=>s+x,0)/a.length }
  function sdOf(a,mean){ return Math.sqrt(a.reduce((s,x)=>s+(x-mean)*(x-mean),0)/a.length) }
  function quantile(sortedArr,q){ const pos=(sortedArr.length-1)*q; const base=Math.floor(pos); const rest=pos-base; return (sortedArr[base+1]!==undefined) ? (sortedArr[base] + rest*(sortedArr[base+1]-sortedArr[base])) : sortedArr[base]; }
})();
</script>
</body>
</html>
